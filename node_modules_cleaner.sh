#!/bin/bash

TARGET_DIR="${1:-.}"

# Detect platform
OS_TYPE=$(uname)

echo "Searching..."

node_modules_dirs=$(find "$TARGET_DIR" -type d -name "node_modules" -prune)

if [ -z "$node_modules_dirs" ]; then
  echo "No node_modules directories found."
  exit 0
fi

total_size_before=0
directory_count=0

while IFS= read -r dir; do
  if [ "$OS_TYPE" = "Linux" ]; then
    size=$(du -sb "$dir" 2>/dev/null | awk '{print $1}')
  elif [ "$OS_TYPE" = "Darwin" ]; then
    size=$(du -sk "$dir" 2>/dev/null | awk '{print $1}')
    size=$(echo "$size*1024" | bc)  # Convert to bytes for macOS
  elif [[ "$OS_TYPE" == *"_NT"* ]]; then
    size=$(du -sb "$dir" 2>/dev/null | awk '{print $1}')
  else
    echo "Unsupported OS: $OS_TYPE"
    exit 1
  fi
  
  total_size_before=$(echo "$total_size_before + $size" | bc)
  directory_count=$((directory_count + 1))

  clear
  echo "Path: $TARGET_DIR"
  echo "Found node_modules: $directory_count"
  echo "Calculated size: $(echo "scale=2; $total_size_before/1024/1024" | bc) MB"
  echo "Searching... Please wait for a while."
done <<< "$node_modules_dirs"

clear
echo "Path: $TARGET_DIR"
echo "Found $directory_count node_modules."
echo "Total size: $(echo "scale=2; $total_size_before/1024/1024" | bc) MB"

read -p "Do you want to delete all these node_modules directories? (y/n) " confirm

if [[ $confirm == [yY] ]]; then
  echo "Deleting..."

  if [ "$OS_TYPE" = "Linux" ]; then
    echo "$node_modules_dirs" | xargs -d '\n' rm -rf
  elif [ "$OS_TYPE" = "Darwin" ]; then
    echo "$node_modules_dirs" | xargs -I {} rm -rf "{}"
  elif [[ "$OS_TYPE" == *"_NT"* ]]; then
    echo "$node_modules_dirs" | xargs -d '\n' rm -rf
  else
    echo "Unsupported OS: $OS_TYPE"
    exit 1
  fi
  
  echo "All node_modules directories have been deleted."
else
  echo "Deletion cancelled."
fi
