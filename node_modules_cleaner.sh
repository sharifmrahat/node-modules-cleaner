#!/bin/bash

TARGET_DIR="${1:-.}"

echo "Searching..."

node_modules_dirs=$(find "$TARGET_DIR" -type d -name "node_modules" -prune)

if [ -z "$node_modules_dirs" ]; then
  echo "No node_modules directories found."
  exit 0
fi

total_size_before=0
directory_count=0


while IFS= read -r dir; do
  size=$(du -sb "$dir" 2>/dev/null | awk '{print $1}')
  total_size_before=$(echo "$total_size_before + $size" | bc)
  directory_count=$((directory_count + 1))
  
  clear
  echo "Path: $TARGET_DIR"
  echo "Found node_modules: $directory_count"
  echo "Calculated size: $(echo "scale=2; $total_size_before/1024/1024" | bc) MB"
  echo "Searching... Please wait for a while."
done <<< "$node_modules_dirs"

clear
echo "Path: $TARGET_DIR"
echo "Found $directory_count node_modules."
echo "Total size: $(echo "scale=2; $total_size_before/1024/1024" | bc) MB"

read -p "Do you want to delete all these node_modules directories? (y/n) " confirm

if [[ $confirm == [yY] ]]; then
  echo "Deleting..."
  echo "$node_modules_dirs" | xargs -d '\n' rm -rf
  echo "All node_modules directories have been deleted."
else
  echo "Cancelled deletation."
fi

